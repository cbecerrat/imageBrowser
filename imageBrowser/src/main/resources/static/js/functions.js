var black = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAeAB4AAD/2wBDAAIBAQIBAQICAgICAgICAwUDAwMDAwYEBAMFBwYHBwcGBwcICQsJCAgKCAcHCg0KCgsMDAwMBwkODw0MDgsMDAz/2wBDAQICAgMDAwYDAwYMCAcIDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCAEsAZADASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD+f+iiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/2Q==";
var	imgNames = [];
var imgs = {};
var current = 0;
var total = 0;
var currentKeywords = [];
var currentImage = '';
var csv_content = '';

function handleFile(e) {
	imgNames = [];
	imgs = {};	
	$("#keywordsSelected").val('');
	currentImage = '';
		
	$("#importCSV").attr("disabled", "disabled");

	var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.csv|.txt)$/;
	if (regex.test($("#fileSelector").val().toLowerCase())) {
		if (typeof (FileReader) != "undefined") {
			var reader = new FileReader();
			reader.onload = function (e) {
				var rows = e.target.result.split("\n");
				$.each(rows, function (index, value) {
					var cells = value.split(",");
					if(cells.length >= 2){
						imgName = cells[0];
						keyWords = cells[1].split(" ");
						imgs[imgName] = keyWords;
						imgNames.push(imgName);
					}
				});
				
				rows = undefined;
				if(imgNames.length != 0){					
					handleRows(imgs, imgNames);
					$('#link').removeClass('disabled');
				}

				$("#message").text("");							
			}
			
			reader.readAsText($("#fileSelector")[0].files[0]);
		} else {
			alert("This browser does not support HTML5.");
		}
	} else {
		$("#message").css("color", 'red');
		$("#message").text("Please upload a valid CSV file.");
		current = 0;
		total = 0;
		$("#current").text(current);					
		$("#total").text(total);
		$("#keywordButtons").empty();
		$('#theImage').attr('src', black);
		$("#keywordsSelected").val('');
		$('#link').addClass('disabled');
		currentImage = '';
		imgNames = [];
		imgs = {};
	}
	
	$("#importCSV").removeAttr("disabled");
}

function handleRows(imgs, imgNames){
	currentImage = imgNames[0]
	current = 1;
	total = imgNames.length;
	$("#current").text(current);
	$("#total").text(total);
	getImgByName(currentImage);
}

function getImgByName(name){
	currentImage = name;
	$('#theImage').attr('src', 'images/' + name);
	
	getKeywordsForImage(name);
}

function getKeywordsForImage(name){
	currentKeywords = [];
	
	$("#keywordButtons").empty();
	$.each(imgs[name], function (index, value) {		
		var button = $('<button/>',
	    {
	        text: value,
	        id: index,
	        name: value,
	        'class': 'btn btn-light',
	        style: 'border: 2px solid black; margin-right: 10px; margin-top: 10px;',
	        click: function (event) {
	        	handleKeyword(this.id, this.name);
	        	
	        	handleClass(this, this.className);
	        	
	        	fillKeywords();
	        }, keyup: function(event) {
	    		event.preventDefault();
	        }
	    });
		$("#keywordButtons").append(button);		
	});
}

function handleKeyword(id, name){
	if($.inArray(name, currentKeywords) !== -1){	
		currentKeywords.splice($.inArray(name, currentKeywords),1);
	}else{
		currentKeywords.push(name);
	}
}

function handleClass(button, clazz){
	if(clazz === 'btn btn-light'){
		$(button).removeClass(clazz);
		$(button).addClass('btn btn-primary');
	}else{
		$(button).removeClass('btn btn-primary');
		$(button).addClass('btn btn-light');
	}
}

function fillKeywords(){
	keywordsSelected = currentKeywords.join(" ");		
	
	$("#keywordsSelected").val(keywordsSelected);	
}

$(document).ready(function(){
	$('#link').addClass('disabled');
	
	$('#fileSelector').change(handleFile);
	$('#previous').click(function(){
		$("#keywordsSelected").val('');
		if(current > 1){
			current--;
			$("#current").text(current);
			$("#message").text('');
			getImgByName(imgNames[current - 1]);
		}
	});
	
	$('#next').click(function(){
		$("#keywordsSelected").val('');
		if(current < total){
			current++;
			$("#current").text(current);
			$("#message").text('');
			getImgByName(imgNames[current - 1]);
		}
	});
	

	$('body').keyup(function(event) {
		event.preventDefault();
		if (event.keyCode == 32) {			
			if(current < total){
				imgs[currentImage] = currentKeywords;
				$("#keywordsSelected").val('');
				current++;
				$("#current").text(current);
				getImgByName(imgNames[current - 1]);
			}else{
				imgs[currentImage] = currentKeywords;
				$("#message").css("color", 'blue');
				$("#message").text("No more elements. You can review before export the result.");
			}
		}
	});
	
	$('#link').click(function() {
		if(imgs !== undefined){
			csv_content = '';
			imgs[currentImage] = currentKeywords;
			Object.keys(imgs).forEach(function(key) {
				csv_content += key + ',' + imgs[key].join(' ') + '\n';				
			});
			csv_content = encodeURIComponent(csv_content);
			csv_content = csv_content.replace(/%0D/g, '');
			
			this.href = 'data:text/csv;charset=utf-8,' + csv_content;
		}
	});
});